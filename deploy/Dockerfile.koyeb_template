FROM ubuntu AS builder

RUN apt update && apt install curl unzip jq -y

#1

WORKDIR /app

COPY scripts ./scripts

RUN sh scripts/download_data.sh $PRE_SET_ENCRYPTED_URI $PRE_SET_ENCRYPTED_PASSWORD

RUN sh scripts/manual-download-docker-image.sh

FROM koyeb/docker-compose

RUN apk add --no-cache git openjdk17-jdk

#1

WORKDIR /app

COPY . .

#2

COPY --from=builder /app/data ./deploy/pre_set_data
COPY --from=builder /app/deploy/docker-images ./deploy/docker-images

ENV IS_HOST=true

RUN --mount=type=cache,target=/root/.gradle \
    sh scripts/build-server-on-condition.sh

CMD sh ./scripts/build-koyeb.sh
